import 'dart:math';

class ChiCuadradaTable {
  static const Map<int, Map<double, double>> _table = {
    // DF: {P: value}
    1: {0.995: 0.0000393, 0.975: 0.000982, 0.05: 3.841, 0.025: 5.024, 0.01: 6.635},
    2: {0.995: 0.0100, 0.975: 0.0506, 0.05: 5.991, 0.025: 7.378, 0.01: 9.210},
    3: {0.995: 0.0717, 0.975: 0.216, 0.05: 7.815, 0.025: 9.348, 0.01: 11.345},
    4: {0.995: 0.207, 0.975: 0.484, 0.05: 9.488, 0.025: 11.143, 0.01: 13.277},
    5: {0.995: 0.412, 0.975: 0.831, 0.05: 11.070, 0.025: 12.833, 0.01: 15.086},
    6: {0.995: 0.676, 0.975: 1.237, 0.05: 12.592, 0.025: 14.449, 0.01: 16.812},
    7: {0.995: 0.989, 0.975: 1.690, 0.05: 14.067, 0.025: 16.013, 0.01: 18.475},
    8: {0.995: 1.344, 0.975: 2.180, 0.05: 15.507, 0.025: 17.535, 0.01: 20.090},
    9: {0.995: 1.735, 0.975: 2.700, 0.05: 16.919, 0.025: 19.023, 0.01: 21.666},
    10: {0.995: 2.156, 0.975: 3.247, 0.05: 18.307, 0.025: 20.483, 0.01: 23.209},
    11: {0.995: 2.603, 0.975: 3.816, 0.05: 19.675, 0.025: 21.920, 0.01: 24.725},
    12: {0.995: 3.074, 0.975: 4.404, 0.05: 21.026, 0.025: 23.337, 0.01: 26.217},
    13: {0.995: 3.565, 0.975: 5.009, 0.05: 22.362, 0.025: 24.736, 0.01: 27.688},
    14: {0.995: 4.075, 0.975: 5.629, 0.05: 23.685, 0.025: 26.119, 0.01: 29.141},
    15: {0.995: 4.601, 0.975: 6.262, 0.05: 24.996, 0.025: 27.488, 0.01: 30.578},
    16: {0.995: 5.142, 0.975: 6.908, 0.05: 26.296, 0.025: 28.845, 0.01: 32.000},
    17: {0.995: 5.697, 0.975: 7.564, 0.05: 27.587, 0.025: 30.191, 0.01: 33.409},
    18: {0.995: 6.265, 0.975: 8.231, 0.05: 28.869, 0.025: 31.526, 0.01: 34.805},
    19: {0.995: 6.844, 0.975: 8.907, 0.05: 30.144, 0.025: 32.852, 0.01: 36.191},
    20: {0.995: 7.434, 0.975: 9.591, 0.05: 31.410, 0.025: 34.170, 0.01: 37.566},
    21: {0.995: 8.034, 0.975: 10.283, 0.05: 32.671, 0.025: 35.479, 0.01: 38.932},
    22: {0.995: 8.643, 0.975: 10.982, 0.05: 33.924, 0.025: 36.781, 0.01: 40.289},
    23: {0.995: 9.260, 0.975: 11.689, 0.05: 35.172, 0.025: 38.076, 0.01: 41.638},
    24: {0.995: 9.886, 0.975: 12.401, 0.05: 36.415, 0.025: 39.364, 0.01: 42.980},
    25: {0.995: 10.520, 0.975: 13.120, 0.05: 37.652, 0.025: 40.646, 0.01: 44.314},
    26: {0.995: 11.160, 0.975: 13.844, 0.05: 38.885, 0.025: 41.923, 0.01: 45.642},
    27: {0.995: 11.808, 0.975: 14.573, 0.05: 40.113, 0.025: 43.195, 0.01: 46.963},
    28: {0.995: 12.461, 0.975: 15.308, 0.05: 41.337, 0.025: 44.461, 0.01: 48.278},
    29: {0.995: 13.121, 0.975: 16.047, 0.05: 42.557, 0.025: 45.722, 0.01: 49.588},
    30: {0.995: 13.787, 0.975: 16.791, 0.05: 43.773, 0.025: 46.979, 0.01: 50.892},
    31: {0.995: 14.458, 0.975: 17.539, 0.05: 44.985, 0.025: 48.232, 0.01: 52.191},
    32: {0.995: 15.134, 0.975: 18.291, 0.05: 46.194, 0.025: 49.480, 0.01: 53.486},
    33: {0.995: 15.815, 0.975: 19.047, 0.05: 47.400, 0.025: 50.725, 0.01: 54.776},
    34: {0.995: 16.501, 0.975: 19.806, 0.05: 48.602, 0.025: 51.966, 0.01: 56.061},
    35: {0.995: 17.192, 0.975: 20.569, 0.05: 49.802, 0.025: 53.203, 0.01: 57.342},
    36: {0.995: 17.887, 0.975: 21.336, 0.05: 50.998, 0.025: 54.437, 0.01: 58.619},
    37: {0.995: 18.586, 0.975: 22.106, 0.05: 52.192, 0.025: 55.668, 0.01: 59.893},
    38: {0.995: 19.289, 0.975: 22.878, 0.05: 53.384, 0.025: 56.896, 0.01: 61.162},
    39: {0.995: 19.996, 0.975: 23.654, 0.05: 54.572, 0.025: 58.120, 0.01: 62.428},
    40: {0.995: 20.707, 0.975: 24.433, 0.05: 55.758, 0.025: 59.342, 0.01: 63.691},
    41: {0.995: 21.421, 0.975: 25.215, 0.05: 56.942, 0.025: 60.561, 0.01: 64.950},
    42: {0.995: 22.138, 0.975: 25.999, 0.05: 58.124, 0.025: 61.777, 0.01: 66.206},
    43: {0.995: 22.859, 0.975: 26.785, 0.05: 59.304, 0.025: 62.990, 0.01: 67.459},
    44: {0.995: 23.584, 0.975: 27.575, 0.05: 60.481, 0.025: 64.201, 0.01: 68.710},
    45: {0.995: 24.311, 0.975: 28.366, 0.05: 61.656, 0.025: 65.410, 0.01: 69.957},
    46: {0.995: 25.041, 0.975: 29.160, 0.05: 62.830, 0.025: 66.617, 0.01: 71.201},
    47: {0.995: 25.775, 0.975: 29.956, 0.05: 64.001, 0.025: 67.821, 0.01: 72.443},
    48: {0.995: 26.511, 0.975: 30.755, 0.05: 65.171, 0.025: 69.023, 0.01: 73.683},
    49: {0.995: 27.249, 0.975: 31.555, 0.05: 66.339, 0.025: 70.222, 0.01: 74.919},
    50: {0.995: 27.991, 0.975: 32.357, 0.05: 67.505, 0.025: 71.420, 0.01: 76.154},
    51: {0.995: 28.735, 0.975: 33.162, 0.05: 68.669, 0.025: 72.616, 0.01: 77.386},
    52: {0.995: 29.481, 0.975: 33.968, 0.05: 69.832, 0.025: 73.810, 0.01: 78.616},
    53: {0.995: 30.230, 0.975: 34.776, 0.05: 70.993, 0.025: 75.002, 0.01: 79.843},
    54: {0.995: 30.981, 0.975: 35.586, 0.05: 72.153, 0.025: 76.192, 0.01: 81.069},
    55: {0.995: 31.735, 0.975: 36.398, 0.05: 73.311, 0.025: 77.380, 0.01: 82.292},
    56: {0.995: 32.490, 0.975: 37.212, 0.05: 74.468, 0.025: 78.567, 0.01: 83.513},
    57: {0.995: 33.248, 0.975: 38.027, 0.05: 75.624, 0.025: 79.752, 0.01: 84.733},
    58: {0.995: 34.008, 0.975: 38.844, 0.05: 76.778, 0.025: 80.936, 0.01: 85.950},
    59: {0.995: 34.770, 0.975: 39.662, 0.05: 77.931, 0.025: 82.117, 0.01: 87.166},
    60: {0.995: 35.534, 0.975: 40.482, 0.05: 79.082, 0.025: 83.298, 0.01: 88.379},
    61: {0.995: 36.301, 0.975: 41.303, 0.05: 80.232, 0.025: 84.476, 0.01: 89.591},
    62: {0.995: 37.068, 0.975: 42.126, 0.05: 81.381, 0.025: 85.654, 0.01: 90.802},
    63: {0.995: 37.838, 0.975: 42.950, 0.05: 82.529, 0.025: 86.830, 0.01: 92.010},
    64: {0.995: 38.610, 0.975: 43.776, 0.05: 83.675, 0.025: 88.004, 0.01: 93.217},
    65: {0.995: 39.383, 0.975: 44.603, 0.05: 84.821, 0.025: 89.177, 0.01: 94.422},
    66: {0.995: 40.158, 0.975: 45.431, 0.05: 85.965, 0.025: 90.349, 0.01: 95.626},
    67: {0.995: 40.935, 0.975: 46.261, 0.05: 87.108, 0.025: 91.519, 0.01: 96.828},
    68: {0.995: 41.713, 0.975: 47.092, 0.05: 88.250, 0.025: 92.689, 0.01: 98.028},
    69: {0.995: 42.494, 0.975: 47.924, 0.05: 89.391, 0.025: 93.856, 0.01: 99.228},
    70: {0.995: 43.275, 0.975: 48.758, 0.05: 90.531, 0.025: 95.023, 0.01: 100.425},
    71: {0.995: 44.058, 0.975: 49.592, 0.05: 91.670, 0.025: 96.189, 0.01: 101.621},
    72: {0.995: 44.843, 0.975: 50.428, 0.05: 92.808, 0.025: 97.353, 0.01: 102.816},
    73: {0.995: 45.629, 0.975: 51.265, 0.05: 93.945, 0.025: 98.516, 0.01: 104.010},
    74: {0.995: 46.417, 0.975: 52.103, 0.05: 95.081, 0.025: 99.678, 0.01: 105.202},
    75: {0.995: 47.206, 0.975: 52.942, 0.05: 96.217, 0.025: 100.839, 0.01: 106.393},
    76: {0.995: 47.997, 0.975: 53.782, 0.05: 97.351, 0.025: 101.999, 0.01: 107.583},
    77: {0.995: 48.788, 0.975: 54.623, 0.05: 98.484, 0.025: 103.158, 0.01: 108.771},
    78: {0.995: 49.582, 0.975: 55.466, 0.05: 99.617, 0.025: 104.316, 0.01: 109.958},
    79: {0.995: 50.376, 0.975: 56.309, 0.05: 100.749, 0.025: 105.473, 0.01: 111.144},
    80: {0.995: 51.172, 0.975: 57.153, 0.05: 101.879, 0.025: 106.629, 0.01: 112.329},
    81: {0.995: 51.969, 0.975: 57.998, 0.05: 103.010, 0.025: 107.783, 0.01: 113.512},
    82: {0.995: 52.767, 0.975: 58.845, 0.05: 104.139, 0.025: 108.937, 0.01: 114.695},
    83: {0.995: 53.567, 0.975: 59.692, 0.05: 105.267, 0.025: 110.090, 0.01: 115.876},
    84: {0.995: 54.368, 0.975: 60.540, 0.05: 106.395, 0.025: 111.242, 0.01: 117.057},
    85: {0.995: 55.170, 0.975: 61.389, 0.05: 107.522, 0.025: 112.393, 0.01: 118.236},
    86: {0.995: 55.973, 0.975: 62.239, 0.05: 108.648, 0.025: 113.544, 0.01: 119.414},
    87: {0.995: 56.777, 0.975: 63.089, 0.05: 109.773, 0.025: 114.693, 0.01: 120.591},
    88: {0.995: 57.582, 0.975: 63.941, 0.05: 110.898, 0.025: 115.841, 0.01: 121.767},
    89: {0.995: 58.389, 0.975: 64.793, 0.05: 112.022, 0.025: 116.989, 0.01: 122.942},
    90: {0.995: 59.196, 0.975: 65.647, 0.05: 113.145, 0.025: 118.136, 0.01: 124.116},
    91: {0.995: 60.005, 0.975: 66.501, 0.05: 114.268, 0.025: 119.282, 0.01: 125.289},
    92: {0.995: 60.815, 0.975: 67.356, 0.05: 115.390, 0.025: 120.427, 0.01: 126.462},
    93: {0.995: 61.625, 0.975: 68.211, 0.05: 116.511, 0.025: 121.571, 0.01: 127.633},
    94: {0.995: 62.437, 0.975: 69.068, 0.05: 117.632, 0.025: 122.715, 0.01: 128.803},
    95: {0.995: 63.250, 0.975: 69.925, 0.05: 118.752, 0.025: 123.858, 0.01: 129.973},
    96: {0.995: 64.063, 0.975: 70.783, 0.05: 119.871, 0.025: 125.000, 0.01: 131.141},
    97: {0.995: 64.878, 0.975: 71.642, 0.05: 120.990, 0.025: 126.141, 0.01: 132.309},
    98: {0.995: 65.694, 0.975: 72.501, 0.05: 122.108, 0.025: 127.282, 0.01: 133.476},
    99: {0.995: 66.510, 0.975: 73.361, 0.05: 123.225, 0.025: 128.422, 0.01: 134.642},
    100: {0.995: 67.328, 0.975: 74.222, 0.05: 124.342, 0.025: 129.561, 0.01: 135.807},
    101: {0.995: 68.146, 0.975: 75.083, 0.05: 125.458, 0.025: 130.700, 0.01: 136.971},
    102: {0.995: 68.965, 0.975: 75.946, 0.05: 126.574, 0.025: 131.838, 0.01: 138.134},
    103: {0.995: 69.785, 0.975: 76.809, 0.05: 127.689, 0.025: 132.975, 0.01: 139.297},
    104: {0.995: 70.606, 0.975: 77.672, 0.05: 128.804, 0.025: 134.111, 0.01: 140.459},
    105: {0.995: 71.428, 0.975: 78.536, 0.05: 129.918, 0.025: 135.247, 0.01: 141.620},
    106: {0.995: 72.251, 0.975: 79.401, 0.05: 131.031, 0.025: 136.382, 0.01: 142.780},
    107: {0.995: 73.075, 0.975: 80.267, 0.05: 132.144, 0.025: 137.517, 0.01: 143.940},
    108: {0.995: 73.899, 0.975: 81.133, 0.05: 133.257, 0.025: 138.651, 0.01: 145.099},
    109: {0.995: 74.724, 0.975: 82.000, 0.05: 134.369, 0.025: 139.784, 0.01: 146.257},
    110: {0.995: 75.550, 0.975: 82.867, 0.05: 135.480, 0.025: 140.917, 0.01: 147.414},
    111: {0.995: 76.377, 0.975: 83.735, 0.05: 136.591, 0.025: 142.049, 0.01: 148.571},
    112: {0.995: 77.204, 0.975: 84.604, 0.05: 137.701, 0.025: 143.180, 0.01: 149.727},
    113: {0.995: 78.033, 0.975: 85.473, 0.05: 138.811, 0.025: 144.311, 0.01: 150.882},
    114: {0.995: 78.862, 0.975: 86.342, 0.05: 139.921, 0.025: 145.441, 0.01: 152.037},
    115: {0.995: 79.692, 0.975: 87.213, 0.05: 141.030, 0.025: 146.571, 0.01: 153.191},
    116: {0.995: 80.522, 0.975: 88.084, 0.05: 142.138, 0.025: 147.700, 0.01: 154.344},
    117: {0.995: 81.353, 0.975: 88.955, 0.05: 143.246, 0.025: 148.829, 0.01: 155.496},
    118: {0.995: 82.185, 0.975: 89.827, 0.05: 144.354, 0.025: 149.957, 0.01: 156.648},
    119: {0.995: 83.018, 0.975: 90.700, 0.05: 145.461, 0.025: 151.084, 0.01: 157.800},
    120: {0.995: 83.852, 0.975: 91.573, 0.05: 146.567, 0.025: 152.211, 0.01: 158.950},
    121: {0.995: 84.686, 0.975: 92.446, 0.05: 147.674, 0.025: 153.338, 0.01: 160.100},
    122: {0.995: 85.520, 0.975: 93.320, 0.05: 148.779, 0.025: 154.464, 0.01: 161.250},
    123: {0.995: 86.356, 0.975: 94.195, 0.05: 149.885, 0.025: 155.589, 0.01: 162.398},
    124: {0.995: 87.192, 0.975: 95.070, 0.05: 150.989, 0.025: 156.714, 0.01: 163.546},
    125: {0.995: 88.029, 0.975: 95.946, 0.05: 152.094, 0.025: 157.839, 0.01: 164.694},
    126: {0.995: 88.866, 0.975: 96.822, 0.05: 153.198, 0.025: 158.962, 0.01: 165.841},
    127: {0.995: 89.704, 0.975: 97.698, 0.05: 154.302, 0.025: 160.086, 0.01: 166.987},
    128: {0.995: 90.543, 0.975: 98.576, 0.05: 155.405, 0.025: 161.209, 0.01: 168.133},
    129: {0.995: 91.382, 0.975: 99.453, 0.05: 156.508, 0.025: 162.331, 0.01: 169.278},
    130: {0.995: 92.222, 0.975: 100.331, 0.05: 157.610, 0.025: 163.453, 0.01: 170.423},
    131: {0.995: 93.063, 0.975: 101.210, 0.05: 158.712, 0.025: 164.575, 0.01: 171.567},
    132: {0.995: 93.904, 0.975: 102.089, 0.05: 159.814, 0.025: 165.696, 0.01: 172.711},
    133: {0.995: 94.746, 0.975: 102.968, 0.05: 160.915, 0.025: 166.816, 0.01: 173.854},
    134: {0.995: 95.588, 0.975: 103.848, 0.05: 162.016, 0.025: 167.936, 0.01: 174.996},
    135: {0.995: 96.431, 0.975: 104.729, 0.05: 163.116, 0.025: 169.056, 0.01: 176.138},
    136: {0.995: 97.275, 0.975: 105.609, 0.05: 164.216, 0.025: 170.175, 0.01: 177.280},
    137: {0.995: 98.119, 0.975: 106.491, 0.05: 165.316, 0.025: 171.294, 0.01: 178.421},
    138: {0.995: 98.964, 0.975: 107.372, 0.05: 166.415, 0.025: 172.412, 0.01: 179.561},
    139: {0.995: 99.809, 0.975: 108.254, 0.05: 167.514, 0.025: 173.530, 0.01: 180.701},
    140: {0.995: 100.655, 0.975: 109.137, 0.05: 168.613, 0.025: 174.648, 0.01: 181.840},
    141: {0.995: 101.501, 0.975: 110.020, 0.05: 169.711, 0.025: 175.765, 0.01: 182.979},
    142: {0.995: 102.348, 0.975: 110.903, 0.05: 170.809, 0.025: 176.882, 0.01: 184.118},
    143: {0.995: 103.196, 0.975: 111.787, 0.05: 171.907, 0.025: 177.998, 0.01: 185.256},
    144: {0.995: 104.044, 0.975: 112.671, 0.05: 173.004, 0.025: 179.114, 0.01: 186.393},
    145: {0.995: 104.892, 0.975: 113.556, 0.05: 174.101, 0.025: 180.229, 0.01: 187.530},
    146: {0.995: 105.741, 0.975: 114.441, 0.05: 175.198, 0.025: 181.344, 0.01: 188.666},
    147: {0.995: 106.591, 0.975: 115.326, 0.05: 176.294, 0.025: 182.459, 0.01: 189.802},
    148: {0.995: 107.441, 0.975: 116.212, 0.05: 177.390, 0.025: 183.573, 0.01: 190.938},
    149: {0.995: 108.291, 0.975: 117.098, 0.05: 178.485, 0.025: 184.687, 0.01: 192.073},
    150: {0.995: 109.142, 0.975: 117.985, 0.05: 179.581, 0.025: 185.800, 0.01: 193.208},
  };

  static double lookup(double p, int df) {
    if (_table.containsKey(df) && _table[df].containsKey(p)) {
      return _table[df][p];
    }
    // Simple interpolation for df values not in the table
    if (df > 150) {
      // For large df, chi-squared distribution approaches normal
      // This is a simplification and may not be accurate for all cases
      return df * pow(1 - 2 / (9 * df) + _getZ(p) * sqrt(2 / (9 * df)), 3);
    }

    // If df is not in the table, try to find the closest lower df and use its value.
    // This is a practical fallback but may not be statistically perfect.
    final closestDf = _table.keys.lastWhere((key) => key < df, orElse: () => null);
    if (closestDf != null && _table[closestDf].containsKey(p)) {
      return _table[closestDf][p];
    }

    return null;
  }

  static double _getZ(double alpha) {
    if (alpha <= 0.01) return 2.58;
    if (alpha <= 0.02) return 2.33;
    if (alpha <= 0.05) return 1.96;
    if (alpha <= 0.1) return 1.645;
    return 1.96; // Default for 95%
  }
}
